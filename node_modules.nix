{ pkgs ? import <nixpkgs> {} }:

with pkgs;
with builtins;

let
  nodejs = pkgs."nodejs-8_x";
  lockedPackages = (fromJSON (readFile ./package-lock.json)).dependencies;
  mkNodeModule = pkgName: props:
    with props;
    let
      splitIntegrity = lib.strings.splitString "-" integrity;
      hashAlg = elemAt splitIntegrity 0;
      hash = elemAt splitIntegrity 1;
    in

    stdenv.mkDerivation {
      inherit version pkgName;
      name = "${pkgName}-${version}";
      src = pkgs.fetchurl {
        url = resolved;
        "${hashAlg}" = hash;
      };

      buildInputs = [ nodejs ];
      phases = [ "unpackPhase" "buildPhase" "installPhase" ];

      buildPhase = ''
        export HOME=$TMPDIR
        npm rebuild
      '';

      installPhase = ''
        mkdir -p $out/$pkgName
        cp -r ./ $out/$pkgName/
      '';
    };
in

stdenv.mkDerivation {
  name = "node_modules";

  phases = [ "buildPhase" "installPhase" ];

  buildPhase = lib.strings.concatStringsSep "\n" (
    map (p: "cp -r ${p}/* ./")
    (lib.mapAttrsToList mkNodeModule lockedPackages));

  installPhase = ''
    mkdir -p $out/node_modules
    cp -r ./ $out/node_modules
  '';
}
